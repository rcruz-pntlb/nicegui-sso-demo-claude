services:
  nicegui-sso-demo:
    build: .
    container_name: nicegui-sso-demo
    restart: unless-stopped
    environment:
      - PORTAL_URL=${PORTAL_URL:-https://petunia.apsagroup.com}
      - PORTAL_INTERNAL_URL=${PORTAL_INTERNAL_URL:-http://172.20.98.171:5000}
      - APP_NAME=${APP_NAME:-NiceGUI Demo}
      - APP_AUDIENCE=${APP_AUDIENCE:-nicegui-demo}
      - BASE_PATH=${BASE_PATH:-/nicegui-demo}
      # ✅ CONFIGURACIÓN WEBSOCKET (CRÍTICO) DEBIDO A UN CORRECTO PASO DE TOKEN EN LAZY SSO
      - WS_MAX_SIZE=${WS_MAX_SIZE:-20971520}
      - WS_PING_INTERVAL=${WS_PING_INTERVAL:-20}
      - WS_PING_TIMEOUT=${WS_PING_TIMEOUT:-20}
      - TIMEOUT_KEEP_ALIVE=${TIMEOUT_KEEP_ALIVE:-300}
    volumes:
      - ./cache:/app/cache
    ports:
      - "8080:8080"
    extra_hosts:
      # TEST: Usar host-gateway para acceder al host Docker
      - "petunia.apsagroup.com:host-gateway"
      # PRODUCCIÓN: Descomentar y ajustar IP interna
      # - "petunia.apsagroup.com:192.168.1.50"

      # Traefik Labels (Optional but recommended for full integration)
    labels:
      - "traefik.enable=true"
      # Router - HTTP
      - "traefik.http.routers.nicegui-demo.rule=PathPrefix(`${BASE_PATH:-/nicegui-demo}`)"
      - "traefik.http.routers.nicegui-demo.entrypoints=websecure"
      - "traefik.http.routers.nicegui-demo.tls=true"
      # Middlewares - Strip Prefix (Important so app receives '/')
      - "traefik.http.middlewares.nicegui-strip.stripprefix.prefixes=${BASE_PATH:-/nicegui-demo}"
      - "traefik.http.routers.nicegui-demo.middlewares=nicegui-strip"
      # Service
      - "traefik.http.services.nicegui-demo.loadbalancer.server.port=8080"
